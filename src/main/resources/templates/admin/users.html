<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${pageTitle}">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - MotoShop</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .navbar {
      margin-bottom: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .user-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      background: #fafafa;
    }
    .user-info {
      margin-bottom: 10px;
    }
    .role-select {
      width: 200px;
      padding: 5px;
      margin: 5px 0;
    }
    .btn {
      padding: 8px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-primary { background: #007bff; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: black; }
    .status-enabled { color: green; font-weight: bold; }
    .status-disabled { color: red; font-weight: bold; }
    .loading {
      text-align: center;
      padding: 20px;
      font-size: 18px;
    }
    .search-box {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" href="/admin/dashboard">üèçÔ∏è MotoShop Admin</a>
    <div class="navbar-nav ms-auto">
      <a class="nav-link" href="/admin/dashboard">üìä –î–∞—à–±–æ—Ä–¥</a>
      <a class="nav-link active" href="/admin/users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
      <a class="nav-link" href="/admin/products">üõçÔ∏è –¢–æ–≤–∞—Ä—ã</a>
      <a class="nav-link" href="/admin/orders">üì¶ –ó–∞–∫–∞–∑—ã</a>
      <a class="nav-link" href="/profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
      <form action="/api/auth/logout" method="post" class="d-inline">
        <button type="submit" class="btn btn-outline-light btn-sm">üö™ –í—ã–π—Ç–∏</button>
      </form>
    </div>
  </div>
</nav>

<div class="container">
  <h1>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>

  <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
  <div class="search-box">
    <div class="row">
      <div class="col-md-6">
        <input type="text" id="searchInput" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email...">
      </div>
      <div class="col-md-3">
        <select id="roleFilter" class="form-select">
          <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
          <option value="ROLE_USER">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
          <option value="ROLE_MODERATOR">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
          <option value="ROLE_ADMIN">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="statusFilter" class="form-select">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="true">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
          <option value="false">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
        </select>
      </div>
    </div>
  </div>

  <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
  <div id="users-list" style="display: none;"></div>
  <div id="error-message" class="alert alert-danger" style="display: none;"></div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="row mt-4" id="stats" style="display: none;">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h5>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
          <h3 id="totalUsers">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5>–ê–∫—Ç–∏–≤–Ω—ã—Ö</h5>
          <h3 id="activeUsers">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h5>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h5>
          <h3 id="adminUsers">0</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h5>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</h5>
          <h3 id="moderatorUsers">0</h3>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_BASE = '/api/admin';

  // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ cookie
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  let authToken = getCookie('jwtToken') || localStorage.getItem('authToken');
  let allUsers = [];

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    if (!authToken) {
      window.location.href = '/api/auth/login';
      return;
    }
    loadUsers();

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('searchInput').addEventListener('input', filterUsers);
    document.getElementById('roleFilter').addEventListener('change', filterUsers);
    document.getElementById('statusFilter').addEventListener('change', filterUsers);
  });

  async function loadUsers() {
    try {
      const response = await axios.get(`${API_BASE}/users`, {
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        }
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('users-list').style.display = 'block';
      document.getElementById('stats').style.display = 'flex';

      allUsers = response.data;
      displayUsers(allUsers);
      updateStats(allUsers);

    } catch (error) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error-message').style.display = 'block';
      document.getElementById('error-message').textContent =
              '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + (error.response?.data?.message || error.message);

      if (error.response?.status === 401 || error.response?.status === 403) {
        setTimeout(() => {
          window.location.href = '/api/auth/login';
        }, 2000);
      }
    }
  }

  function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const roleFilter = document.getElementById('roleFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;

    const filteredUsers = allUsers.filter(user => {
      const matchesSearch = user.username.toLowerCase().includes(searchTerm) ||
              user.email.toLowerCase().includes(searchTerm);
      const matchesRole = !roleFilter || user.role === roleFilter;
      const matchesStatus = statusFilter === '' || user.enabled.toString() === statusFilter;

      return matchesSearch && matchesRole && matchesStatus;
    });

    displayUsers(filteredUsers);
  }

  function updateStats(users) {
    document.getElementById('totalUsers').textContent = users.length;
    document.getElementById('activeUsers').textContent = users.filter(u => u.enabled).length;
    document.getElementById('adminUsers').textContent = users.filter(u => u.role === 'ROLE_ADMIN').length;
    document.getElementById('moderatorUsers').textContent = users.filter(u => u.role === 'ROLE_MODERATOR').length;
  }

  function displayUsers(users) {
    const usersList = document.getElementById('users-list');
    usersList.innerHTML = '';

    if (users.length === 0) {
      usersList.innerHTML = '<div class="alert alert-info">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
      return;
    }

    users.forEach(user => {
      const userCard = document.createElement('div');
      userCard.className = 'user-card';
      userCard.innerHTML = `
                    <div class="user-info">
                        <strong>ID:</strong> ${user.id} |
                        <strong>–ò–º—è:</strong> ${user.username} |
                        <strong>Email:</strong> ${user.email} |
                        <strong>–†–æ–ª—å:</strong>
                        <span class="badge ${getRoleBadgeClass(user.role)}">${getRoleDisplayName(user.role)}</span> |
                        <strong>–°—Ç–∞—Ç—É—Å:</strong>
                        <span class="status-${user.enabled ? 'enabled' : 'disabled'}">
                            ${user.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                        </span>
                    </div>

                    <div class="mt-2">
                        <strong>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å:</strong>
                        <select class="role-select form-select" id="role-${user.id}">
                            <option value="ROLE_USER" ${user.role === 'ROLE_USER' ? 'selected' : ''}>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                            <option value="ROLE_MODERATOR" ${user.role === 'ROLE_MODERATOR' ? 'selected' : ''}>üõ°Ô∏è –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</option>
                            <option value="ROLE_ADMIN" ${user.role === 'ROLE_ADMIN' ? 'selected' : ''}>‚ö° –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                        </select>
                    </div>

                    <div class="mt-2">
                        <button class="btn btn-primary" onclick="updateRole(${user.id})">üíæ –û–±–Ω–æ–≤–∏—Ç—å —Ä–æ–ª—å</button>
                        <button class="btn ${user.enabled ? 'btn-warning' : 'btn-success'}"
                                onclick="toggleStatus(${user.id})">
                            ${user.enabled ? 'üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                    <hr>
                `;
      usersList.appendChild(userCard);
    });
  }

  function getRoleBadgeClass(role) {
    switch(role) {
      case 'ROLE_ADMIN': return 'bg-danger';
      case 'ROLE_MODERATOR': return 'bg-warning';
      case 'ROLE_USER': return 'bg-primary';
      default: return 'bg-secondary';
    }
  }

  function getRoleDisplayName(role) {
    switch(role) {
      case 'ROLE_ADMIN': return '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
      case 'ROLE_MODERATOR': return '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä';
      case 'ROLE_USER': return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
      default: return role;
    }
  }

  async function updateRole(userId) {
    const select = document.getElementById(`role-${userId}`);
    const selectedRole = select.value;

    try {
      const response = await axios.put(`${API_BASE}/users/${userId}/role`,
              { role: selectedRole },
              { headers: { 'Authorization': `Bearer ${authToken}` } }
      );
      alert(response.data.message || '–†–æ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
      loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–ª–∏: ' + (error.response?.data?.message || error.message));
    }
  }

  async function toggleStatus(userId) {
    try {
      const response = await axios.put(`${API_BASE}/users/${userId}/status`,
              {},
              { headers: { 'Authorization': `Bearer ${authToken}` } }
      );
      alert(response.data.message || '–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω!');
      loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + (error.response?.data?.message || error.message));
    }
  }

  async function deleteUser(userId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
      return;
    }

    try {
      const response = await axios.delete(`${API_BASE}/users/${userId}`, {
        headers: { 'Authorization': `Bearer ${authToken}` }
      });
      alert(response.data.message || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!');
      loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
    } catch (error) {
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + (error.response?.data?.message || error.message));
    }
  }
</script>
</body>
</html>