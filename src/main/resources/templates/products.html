<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoGear - –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@400;700&display=swap"
          rel="stylesheet">
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fff;
            padding-top: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        /* Header styles */
        .header {
            background: #1a1a1a;
            color: white;
            padding: 1rem 0;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Bebas Neue', cursive;
            font-size: 2rem;
            font-weight: bold;
        }

        .logo span {
            color: #ff6b35;
        }

        .nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav a {
            color: white;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .nav a:hover {
            color: #ff6b35;
        }

        .cart-icon {
            background: #ff6b35;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-left: 2rem;
            color: white;
        }

        .auth-section a {
            transition: color 0.3s ease;
        }

        .auth-section a:hover {
            color: #ff6b35;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 30px;
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('/images/catalog-bg.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            border-radius: 10px;
        }

        .page-header h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 3.5rem;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .page-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            background: #ff6b35;
            color: white;
            padding: 0.8rem 1.5rem;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background 0.3s ease;
            border: none;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
        }

        .btn:hover {
            background: #e55a2b;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        /* Products grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .product-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 2px solid #f1f1f1;
        }

        .product-info {
            padding: 20px;
        }

        .product-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.3;
            font-family: 'Bebas Neue', cursive;
            letter-spacing: 1px;
        }

        .product-price {
            font-size: 1.4em;
            color: #ff6b35;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .product-quantity {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .quantity-high {
            background: #d4edda;
            color: #155724;
        }

        .quantity-medium {
            background: #fff3cd;
            color: #856404;
        }

        .quantity-low {
            background: #f8d7da;
            color: #721c24;
        }

        .product-category {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
            padding: 5px 0;
            border-top: 1px solid #eee;
        }

        .product-description {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        /* Error and no products */
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
            text-align: center;
        }

        .no-products {
            text-align: center;
            padding: 60px;
            color: #6c757d;
            font-size: 1.2em;
        }

        /* Footer */
        .footer {
            background: #1a1a1a;
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 40px;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 2.5rem;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            body {
                padding-top: 120px;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
<!-- –®–∞–ø–∫–∞ -->
<header class="header">
    <div class="container">
        <div class="header-content">
            <div class="logo">Moto<span>Gear</span></div>
            <nav class="nav">
                <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/catalog">–ö–∞—Ç–∞–ª–æ–≥</a>
                <a href="#" class="cart-icon">
                    <span aria-hidden="true">üõí</span>
                    <span class="sr-only">–ö–æ—Ä–∑–∏–Ω–∞</span>
                    <span>(0)</span>
                </a>
            </nav>
            <div class="auth-section">
                <a href="/api/auth/login">–í–æ–π—Ç–∏</a>
                <span>|</span>
                <a href="/api/auth/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <div class="page-header">
        <h1>MotoGear</h1>
        <p>–ö–∞—Ç–∞–ª–æ–≥ –º–æ—Ç–æ—ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏</p>
        <div th:if="${selectedCategory != null}">
            <p>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: <strong th:text="${selectedCategory.name}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</strong></p>
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn btn-success" onclick="createNewProduct()">
            Ôºã –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç
        </button>
        <button class="btn" onclick="location.reload()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
        </button>
        <button class="btn btn-danger" onclick="clearFilters()">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>
    </div>


    <div th:if="${products != null and !products.empty}">
        <h2 style="text-align: center; margin-bottom: 30px; font-family: 'Bebas Neue', cursive;">
            –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: <span th:text="${products.size()}">0</span>
        </h2>

        <div class="products-grid">
            <div th:each="product : ${products}" class="product-card">
                <a th:href="@{/product(id=${product.id})}" style="display: block; color: inherit;">
                    <img th:src="${product.imageUrl}"
                         th:alt="${product.name}"
                         class="product-image"
                         onerror="this.src='/images/placeholder-product.jpg'">

                    <div class="product-info">
                        <h3 class="product-title" th:text="${product.name}">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞</h3>
                        <div class="product-price" th:text="'‚ÇΩ' + ${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')}">‚ÇΩ0</div>

                        <!-- –°—Ç–∞—Ç—É—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ -->
                        <span th:classappend="${product.stockQuantity == 0} ? 'quantity-low' : (${product.stockQuantity < 10} ? 'quantity-low' : (${product.stockQuantity < 50} ? 'quantity-medium' : 'quantity-high'))"
                              class="product-quantity">
                            <span th:if="${product.stockQuantity == 0}">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                            <span th:if="${product.stockQuantity > 0 and product.stockQuantity < 10}">
                                –ú–∞–ª–æ: <span th:text="${product.stockQuantity}">0</span> —à—Ç.
                            </span>
                            <span th:if="${product.stockQuantity >= 10}">
                                –í –Ω–∞–ª–∏—á–∏–∏: <span th:text="${product.stockQuantity}">0</span> —à—Ç.
                            </span>
                        </span>

                        <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                        <div th:if="${product.category != null}" class="product-category">
                            –ö–∞—Ç–µ–≥–æ—Ä–∏—è: <span th:text="${product.category.name}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                        </div>

                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                        <p th:if="${product.description != null}" class="product-description" th:text="${product.description}">
                            –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞
                        </p>
                    </div>
                </a>

                <div class="card-actions">
                    <a th:href="@{/product(id=${product.id})}" class="btn btn-sm">
                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </a>
                    <button class="btn btn-success btn-sm" th:onclick="'editProduct(' + ${product.id} + ')'">
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
    <div th:if="${products == null or products.empty}" class="no-products">
        <p>–ü—Ä–æ–¥—É–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞.</p>
        <button class="btn" onclick="window.location.href='/catalog'">
            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
        </button>
    </div>

    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
    <div th:if="${error != null}" class="error">
        <p th:text="${error}">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
    </div>
</div>

<!-- –§—É—Ç–µ—Ä -->
<footer class="footer">
    <div class="container">
        <p>¬© 2025 MotoGear. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </div>
</footer>

<script>
    function viewProduct(productId) {
        window.location.href = '/product?id=' + productId;
    }

    function editProduct(productId) {
        alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ ' + productId);
        // window.location.href = '/edit-product?id=' + productId;
    }

    function createNewProduct() {
        alert('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞');
        // window.location.href = '/create-product';
    }

    function clearFilters() {
        window.location.href = '/catalog';
    }


    function formatPrice(price) {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB'
        }).format(price);
    }
    let authCheckInterval;

    document.addEventListener('DOMContentLoaded', function() {
        checkAuthStatus();
        authCheckInterval = setInterval(checkAuthStatus, 30000);
    });

    async function checkAuthStatus() {
        try {
            const response = await fetch('/api/auth/validate?t=' + Date.now(), {
                headers: {
                    'Cache-Control': 'no-cache'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const isAuthenticated = data.status === 'valid' || data.authenticated === true;

            if (isAuthenticated) {
                const username = data.username || data.user || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                showAuthenticatedUI(username);
            } else {
                showNotAuthenticatedUI();
            }
        } catch (error) {
            console.log('Auth check failed:', error);
            showNotAuthenticatedUI();
        }
    }

    function showAuthenticatedUI(username) {
        document.getElementById('auth-authenticated').style.display = 'flex';
        document.getElementById('auth-not-authenticated').style.display = 'none';
        document.getElementById('username').textContent = username;
    }

    function showNotAuthenticatedUI() {
        document.getElementById('auth-authenticated').style.display = 'none';
        document.getElementById('auth-not-authenticated').style.display = 'flex';
    }

    async function logout(event) {
        event.preventDefault();

        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI –Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            showNotAuthenticatedUI();

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (authCheckInterval) {
                clearInterval(authCheckInterval);
            }

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    credentials: 'include'
                });

                console.log('Logout response status:', response.status);
                // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º logout
                window.location.href = window.location.pathname + '?logout=true&t=' + Date.now();
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = window.location.pathname + '?logout=true&t=' + Date.now();
            }
        }
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã—Ö–æ–¥–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('logout')) {
        showLogoutMessage();
    }

    function showLogoutMessage() {
        const message = document.createElement('div');
        message.className = 'logout-message';
        message.textContent = '–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã';
        document.body.appendChild(message);

        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 3000);
    }
</script>
</body>
</html>