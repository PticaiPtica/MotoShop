<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoGear - –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@400;700&display=swap"
          rel="stylesheet">
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fff;
            padding-top: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logout-message {
            position: fixed;
            top: 100px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }


    </style>
</head>
<body>
<!-- –®–∞–ø–∫–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
<header class="header">
    <div class="container">
        <div class="header-content">
            <div class="logo">Moto<span>Gear</span></div>
            <nav class="nav">
                <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/catalog">–ö–∞—Ç–∞–ª–æ–≥</a>
                <a href="#" class="cart-icon">
                    <span aria-hidden="true">üõí</span>
                    <span class="sr-only">–ö–æ—Ä–∑–∏–Ω–∞</span>
                    <span>(0)</span>
                </a>
            </nav>

            <!-- –ë–ª–æ–∫ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="auth-section" id="auth-authenticated" style="display: none;">
                <span>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="username"></span>!</span>
                <a href="/user/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
                <span>|</span>
                <a href="/api/auth/logout" onclick="logout(event)">–í—ã–π—Ç–∏</a>
            </div>

            <!-- –ë–ª–æ–∫ –¥–ª—è –Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="auth-section" id="auth-not-authenticated" style="display: none;">
                <a href="/api/auth/login">–í–æ–π—Ç–∏</a>
                <span>|</span>
                <a href="/api/auth/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <div class="page-header">
        <h1>MotoGear</h1>
        <p>–ö–∞—Ç–∞–ª–æ–≥ –º–æ—Ç–æ—ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏</p>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω–∞—è —á–∞—Å—Ç—å –≤–∞—à–µ–≥–æ HTML –∫–æ–¥–∞ -->
    <div class="action-buttons">
        <button class="btn" onclick="loadProducts()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
        </button>
        <button class="btn btn-danger" onclick="clearFilters()">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
        </button>
    </div>

    <!-- –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
</div>

<script>
    function viewProduct(productId) {
        window.location.href = '/product?id=' + productId;
    }

    function editProduct(productId) {
        alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ ' + productId);
        // window.location.href = '/edit-product?id=' + productId;
    }

    function createNewProduct() {
        alert('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞');
        // window.location.href = '/create-product';
    }

    function clearFilters() {
        window.location.href = '/catalog';
    }


    function formatPrice(price) {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB'
        }).format(price);
    }

    let authCheckInterval;

    document.addEventListener('DOMContentLoaded', function () {

        document.getElementById('auth-authenticated').style.display = 'none';
        document.getElementById('auth-not-authenticated').style.display = 'none';


        checkAuthStatus();
        authCheckInterval = setInterval(checkAuthStatus, 30000);
    });

    async function checkAuthStatus() {
        try {
            const response = await fetch('/api/auth/validate?t=' + Date.now(), {
                headers: {
                    'Cache-Control': 'no-cache'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Auth data:', data);

            const isAuthenticated = data.status === 'valid' || data.authenticated === true;

            if (isAuthenticated) {
                const username = data.username || data.user || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                showAuthenticatedUI(username);
            } else {
                showNotAuthenticatedUI();
            }
        } catch (error) {
            console.log('Auth check failed:', error);
            showNotAuthenticatedUI();
        }
    }

    function showAuthenticatedUI(username) {
        const authAuth = document.getElementById('auth-authenticated');
        const authNotAuth = document.getElementById('auth-not-authenticated');

        if (authAuth) {
            authAuth.style.display = 'flex';
            document.getElementById('username').textContent = username;
        }
        if (authNotAuth) authNotAuth.style.display = 'none';
    }

    function showNotAuthenticatedUI() {
        const authAuth = document.getElementById('auth-authenticated');
        const authNotAuth = document.getElementById('auth-not-authenticated');

        if (authAuth) authAuth.style.display = 'none';
        if (authNotAuth) authNotAuth.style.display = 'flex';
    }

    async function logout(event) {
        if (event) event.preventDefault();

        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º UI –Ω–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            showNotAuthenticatedUI();

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (authCheckInterval) {
                clearInterval(authCheckInterval);
            }

            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    credentials: 'include'
                });

                console.log('Logout response status:', response.status);
                // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º logout
                window.location.href = '/?logout=true&t=' + Date.now();
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/?logout=true&t=' + Date.now();
            }
        }
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã—Ö–æ–¥–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('logout')) {
        showLogoutMessage();
    }

    function showLogoutMessage() {
        const message = document.createElement('div');
        message.className = 'logout-message';
        message.textContent = '–í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã';
        document.body.appendChild(message);

        setTimeout(() => {
            if (message.parentNode) {
                message.parentNode.removeChild(message);
            }
        }, 3000);
    }
</script>
</body>
</html>